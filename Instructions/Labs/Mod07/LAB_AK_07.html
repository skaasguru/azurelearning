<!doctype html>
<html lang="en">
    <head>
        <title>
            Developing Microsoft Azure Solutions - Module 7: Storing and Consuming Files from Azure Storage
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../../assets/css/style.css@v=d86f0e41cbfc727fd1aa5c93305bbd3184d0b042.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="/azurelearning/index.html">
                Developing Microsoft Azure Solutions
            </a>
            <a href="https://www.skaas.guru" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
              <img src="/azurelearning/assets/img/skaas-symbol.png" alt="skaas logo" style="width:44px">
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    </ul>
                </nav>         
            </aside>
            <hr class="" />
            <article class="col-sm-10 mb-5">
                <h1 id="module-7-storing-and-consuming-files-from-azure-storage">Module 7: Storing and Consuming Files from Azure Storage</h1>

<h1 id="lab-storing-generated-documents-in-azure-storage-blobs">Lab: Storing Generated Documents in Azure Storage Blobs</h1>

<h2 id="exercise-1-implementing-azure-storage-blobs">Exercise 1: Implementing Azure Storage Blobs</h2>

<h4 id="task-1-sign-in-to-the-azure-portal">Task 1: Sign in to the Azure Portal</h4>

<ol>
  <li>
    <p>On the Start screen, click the <strong>Internet Explorer</strong> tile.</p>
  </li>
  <li>
    <p>Go to <em>(<a href="https://portal.azure.com">https://portal.azure.com</a>)</em>.</p>
  </li>
  <li>
    <p>In the email address box, type the email address of your Microsoft account.</p>
  </li>
  <li>
    <p>Click <strong>Next</strong>.</p>
  </li>
  <li>
    <p>In the password box, type the password for your Microsoft account.</p>
  </li>
  <li>
    <p>Click <strong>Sign In</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: If this is your first time logging in to the Portal, you may be prompted with a “Welcome” dialog. You can safely close this dialog and continue.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-2-create-azure-assets">Task 2: Create Azure Assets</h4>

<ol>
  <li>
    <p>In the navigation pane on the left side of the Azure Portal, click <strong>All services</strong>.</p>
  </li>
  <li>
    <p>In the <strong>All services</strong> blade that displays, click <strong>Storage Accounts</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Storage accounts</strong> blade that displays, view your list of Storage instances.</p>
  </li>
  <li>
    <p>At the top of the <strong>Storage accounts</strong> blade, click the <strong>Add</strong> button.</p>
  </li>
  <li>
    <p>In the <strong>Create storage account</strong> blade that displays, perform the following steps:</p>

    <p>a. In the <strong>Name</strong> field, provide the value <strong>star20532[your name in lowercase here]</strong>.</p>

    <p>a. In the <strong>Deployment model</strong> section, ensure that the <em>Resource manager</em> option is selected.</p>

    <p>a. In the <strong>Account kind</strong> list, ensure that the <em>StorageV2 (general purpose v2)</em> option is selected.</p>

    <p>a. In the <strong>Location</strong> list, select the region closest to your current location.</p>

    <p>a. Click on the <strong>Replication</strong> list and select the <strong>Locally-redundant storage (LRS)</strong> option.</p>

    <p>a. In the <strong>Performance</strong> section, ensure that the <em>Standard</em> option is selected.</p>

    <p>a. In the <strong>Access tier</strong> section, ensure that the <em>Hot</em> option is selected.</p>

    <p>a. In the <strong>Secure transfer required</strong> section, ensure that the <em>Enabled</em> option is selected.</p>

    <p>a. In the <strong>Resource group</strong> section, select the <strong>Create new</strong> option.</p>

    <p>a. In the <strong>Resource group</strong> section, locate the dialog box and enter the value <strong>MOD07STOR</strong>.</p>

    <p>a. In the <strong>Virtual networks</strong> section, ensure that the <em>Disabled</em> option is selected.</p>

    <p>a. Click the <strong>Create</strong> button.</p>
  </li>
</ol>

<blockquote>
  <p><strong>Note</strong>: Wait for Azure to finish creating the storage account prior to moving forward with the lab. You will receive a notification when the <em>Storage Account</em> is created.</p>
</blockquote>

<ol>
  <li>
    <p>In the navigation pane on the left side of the Azure Portal, click <strong>All services</strong>.</p>
  </li>
  <li>
    <p>In the <strong>All services</strong> blade that displays, click <strong>Storage Accounts</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Storage accounts</strong> blade that displays, select the Storage account instance that has a prefix of <strong>star20532</strong>.</p>
  </li>
  <li>
    <p>In the <em>Storage account</em> blade, locate the <strong>Settings</strong> section on the left-side of the blade and click the <strong>Access keys</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Keys</strong> pane, select any one of the keys and record the value in the <strong>Connection string</strong> field. You will use this value later in this lab.</p>
  </li>
  <li>
    <p>In the navigation pane on the left side, click <strong>All services</strong>.</p>
  </li>
  <li>
    <p>In the <strong>All services</strong> blade that displays, click <strong>SQL databases</strong>.</p>
  </li>
  <li>
    <p>In the <strong>SQL databases</strong> blade that displays, view your list of SQL databases.</p>
  </li>
  <li>
    <p>At the top of the <strong>SQL databases</strong> blade, click the <strong>Add</strong> button.</p>
  </li>
  <li>
    <p>In the <em>SQL database</em> blade that displays, locate the <strong>Database name</strong> field and provide the value <strong>db20532</strong>.</p>
  </li>
  <li>
    <p>Locate the <strong>Resource group</strong> section, select the <strong>Use existing</strong> option and then select the option <strong>MOD07STOR</strong> from the list.</p>
  </li>
  <li>
    <p>In the <strong>Select source</strong> list, select the value <strong>Blank database</strong>.</p>
  </li>
  <li>
    <p>Click the <strong>Server</strong> option.</p>
  </li>
  <li>
    <p>In the <strong>Server</strong> blade that displays, perform the following actions:</p>

    <p>a. Click <strong>Create a new server</strong>.</p>

    <p>a. In the <strong>New Server</strong> blade that displays, locate the <strong>Server Name</strong> field.</p>

    <p>a. In the <strong>Server name</strong> field, type <strong>sv20532[<em>Your Name Here</em>]</strong>.</p>

    <p>a. In the <strong>Server admin login</strong> field, type <strong>testuser</strong> as login.</p>

    <p>a. In the <strong>Password</strong> field, type <strong>TestPa$$w0rd</strong> as password.</p>

    <p>a. In the <strong>Confirm password</strong> field, type <strong>TestPa$$w0rd</strong>.</p>

    <p>a. In the <strong>Location</strong> list, select the region that is closest to your location.</p>

    <p>a. Click the <strong>Select</strong> button.</p>
  </li>
  <li>
    <p>Back in the <strong>SQL database</strong> blade, click the <strong>Pricing Tier</strong> option.</p>
  </li>
  <li>
    <p>In the <strong>Resource Configuration &amp; Pricing</strong> blade that displays, select the <strong>Basic</strong> option.</p>
  </li>
  <li>
    <p>Click <strong>Apply</strong> to close the blade.</p>
  </li>
  <li>
    <p>Back in the <strong>SQL database</strong> blade, click the <strong>Create</strong> button to create the SQL database and server.</p>
  </li>
</ol>

<blockquote>
  <p><strong>Note</strong>: Wait for Azure to finish creating the SQL Database instance prior to moving forward with the lab. You will receive a notification when the <em>SQL Database</em> is created.</p>
</blockquote>

<ol>
  <li>
    <p>In the navigation pane on the left side of the Azure Portal, click <strong>All services</strong>.</p>
  </li>
  <li>
    <p>In the <strong>All services</strong> blade that displays, click <strong>SQL Database</strong>.</p>
  </li>
  <li>
    <p>In the <strong>SQL Database</strong> blade that displays, select the SQL database instance named <strong>db20532</strong>.</p>
  </li>
  <li>
    <p>In the <em>SQL database</em> blade, locate the <strong>Settings</strong> section on the left-side of the blade and click the <strong>Connection strings</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Connection strings</strong> pane, copy the value of the <strong>ADO.NET</strong> connection string. Be sure to replace the placeholder values for <code>{your_username}</code> and <code>{your_password}</code> with the values <strong>testuser</strong> and <strong>TestPa$$w0rd</strong> respectively.</p>

    <blockquote>
      <p><strong>Note</strong>: For example, if your copied connection string is <code>Server=tcp:sv20532microsoft.database.windows.net,1433;Initial Catalog=db20532;Persist Security Info=False;User ID={your_username};Password={your_password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;</code>, your updated connection string would be <code>Server=tcp:sv20532microsoft.database.windows.net,1433;Initial Catalog=db20532;Persist Security Info=False;User ID=testuser;Password=TestPa$$w0rd;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;</code></p>
    </blockquote>
  </li>
  <li>
    <p>In the navigation pane on the left side of the Azure Portal, click <strong>All services</strong>.</p>
  </li>
  <li>
    <p>In the <strong>All services</strong> blade that displays, click <strong>SQL servers</strong>.</p>
  </li>
  <li>
    <p>In the <strong>SQL servers</strong> blade that displays, select the SQL database instance that has a prefix of <strong>sv20532</strong>.</p>
  </li>
  <li>
    <p>In the <em>SQL server</em> blade, locate the <strong>Security</strong> section on the left-side of the blade and click the <strong>Firewalls and virtual networks</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Firewalls and virtual networks</strong> pane, click the <strong>Add client IP</strong> button to add your virtual machine’s IP Address to the list of allowed IP Address ranges.</p>
  </li>
  <li>
    <p>Click on <strong>Save</strong> at the top of the blade. Once saved, close the confirmation dialog by clicking the <strong>Ok</strong> button.</p>

    <blockquote>
      <p><strong>Note</strong>: It might take couple of minutes for the firewall changes to get updated on server.</p>
    </blockquote>
  </li>
  <li>
    <p>In the navigation pane on the left side of the Azure Portal, click <strong>All services</strong>.</p>
  </li>
  <li>
    <p>In the <strong>All services</strong> blade that displays, click <strong>Azure Cosmos DB</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Azure Cosmos DB</strong> blade that displays, view your list of Storage instances.</p>
  </li>
  <li>
    <p>At the top of the <strong>Azure Cosmos DB</strong> blade, click the <strong>Add</strong> button.</p>
  </li>
  <li>
    <p>In the <strong>New account</strong> blade that displays, perform the following steps:</p>

    <p>a. In the <strong>ID</strong> field, provide the value <strong>nosql20532[your name in lowercase here]</strong>.</p>

    <p>a. In the <strong>API</strong> list, select the <strong>SQL</strong> option.</p>

    <p>a. In the <strong>Resource group</strong> section, select the <strong>Use existing</strong> option.</p>

    <p>a. In the <strong>Resource group</strong> section, select the value <strong>MOD07STOR</strong> from the list.</p>

    <p>a. In the <strong>Location</strong> list, select the region closest to your current location.</p>

    <p>a. Ensure that the <em>Enable geo-redundancy</em> checkbox is un-selected.</p>

    <p>a. In the <strong>Virtual networks</strong> section, ensure that the <em>Disabled</em> option is selected.</p>

    <p>a. Click the <strong>Create</strong> button.</p>
  </li>
</ol>

<blockquote>
  <p><strong>Note</strong>: Wait for Azure to finish creating the Azure Cosmos DB account prior to moving forward with the lab. You will receive a notification when the <em>Azure Cosmos DB account</em> is created.</p>
</blockquote>

<ol>
  <li>
    <p>In the navigation pane on the left side of the Azure Portal, click <strong>All services</strong>.</p>
  </li>
  <li>
    <p>In the <strong>All services</strong> blade that displays, click <strong>Azure Cosmos DB</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Azure Cosmos DB</strong> blade that displays, select the Azure Cosmos DB account instance that has a prefix of <strong>nosql20532</strong>.</p>
  </li>
  <li>
    <p>In the <em>Azure Cosmos DB account</em> blade, locate the <strong>Settings</strong> section on the left-side of the blade and click the <strong>Keys</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Keys</strong> pane, record the values in the <strong>URI</strong> and <strong>PRIMARY KEY</strong> fields. You will use these values later in this lab.</p>
  </li>
</ol>

<h4 id="task-3-update-settings-in-contosoevents-projects">Task 3: Update Settings in Contoso.Events Projects</h4>

<ol>
  <li>
    <p>On the Start screen, click the <strong>Desktop</strong> tile.</p>
  </li>
  <li>
    <p>On the taskbar, click the <strong>File Explorer</strong> icon.</p>
  </li>
  <li>
    <p>In the <em>This PC</em> window, go to <strong>Allfiles (F):\Mod07\Labfiles\Starter</strong>, and then double-click <strong>Contoso.Events.sln</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Build</strong> menu, click <strong>Build Solution</strong>.</p>
  </li>
  <li>
    <p>In Solution Explorer, right-click <strong>Contoso.Events</strong> and select <strong>Manage NuGet Packages for Solution</strong>.</p>
  </li>
  <li>
    <p>Click the <strong>Updates</strong> tab.</p>
  </li>
  <li>
    <p>Select the check box for <strong>Select all packages</strong>.</p>
  </li>
  <li>
    <p>Click <strong>Update</strong>.</p>
  </li>
  <li>
    <p>In the Preview Changes dialog box, click <strong>OK</strong>.</p>
  </li>
  <li>
    <p>In the License Acceptance dialog box, click <strong>I Accept</strong>.</p>
  </li>
  <li>
    <p>Wait for the updates to complete.</p>
  </li>
  <li>
    <p>In the Manage Packages for Solution window, click the <strong>Browse</strong> tab</p>
  </li>
  <li>
    <p>Search for <strong>Microsoft.Azure.WebJobs.Extensions.Storage</strong>.</p>
  </li>
  <li>
    <p>Select the check box to <strong>Include prerelease packages</strong>.</p>
  </li>
  <li>
    <p>In the packages pane, select <strong>Microsoft.Azure.WebJobs.Extensions.Storage</strong>.</p>
  </li>
  <li>
    <p>On the right side of the window, select the check box for <strong>Contoso.Events.Worker</strong>.</p>
  </li>
  <li>
    <p>In the Version drop-down list, make sure <strong>3.0.0</strong> is selected.</p>
  </li>
  <li>
    <p>Click <strong>Install</strong>.</p>
  </li>
  <li>
    <p>In the Preview Changes dialog box, click <strong>OK</strong>.</p>
  </li>
  <li>
    <p>In the License Acceptance dialog box, click <strong>I Accept</strong>.</p>
  </li>
  <li>
    <p>Wait for the updates to complete.</p>
  </li>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane of the Contoso.Events - Microsoft Visual Studio window, expand the <strong>Contoso.Events.Management</strong> project.</p>
  </li>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane, double-click <strong>appsettings.json</strong>.</p>
  </li>
  <li>
    <p>In the JSON object, in line 16, locate the <strong>ConnectionStrings.EventsContextConnectionString</strong> path. Observe that the current value is empty:</p>

    <pre><code> "ConnectionStrings": {
     "EventsContextConnectionString": ""
 },
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>EventsContextConnectionString</strong> property by setting it’s value to the <strong>Connection String</strong> of the <strong>SQL Database</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>In the JSON object, in line 12, locate the <strong>CosmosSettings.EndpointUrl</strong> path. Observe that the current value is empty:</p>

    <pre><code> "CosmosSettings": {
     "DatabaseId": "EventsDatabase",
     "CollectionId": "RegistrationCollection",
     "EndpointUrl": "",
     "AuthorizationKey": ""
 },
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>EndpointUrl</strong> property by setting it’s value to the <strong>Endpoint Uri</strong> of the <strong>Azure Cosmos DB account</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>In the JSON object, in line 13, locate the <strong>CosmosSettings.AuthorizationKey</strong> path. Observe that the current value is empty:</p>

    <pre><code> "CosmosSettings": {
     "DatabaseId": "EventsDatabase",
     "CollectionId": "RegistrationCollection",
     "EndpointUrl": "",
     "AuthorizationKey": ""
 },
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>AuthorizationKey</strong> property by setting it’s value to the <strong>Key</strong> of the <strong>Azure Cosmos DB account</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>In the JSON object, in line 6, locate the <strong>StorageSettings.ConnectionString</strong> path. Observe that the current value is empty:</p>

    <pre><code> "StorageSettings": {
     "ConnectionString": "",
     "ContainerName": "signinsheets"
 },
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>ConnectionString</strong> property by setting it’s value to the <strong>Connection String</strong> of the <strong>Storage account</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>Save the <strong>appsettings.json</strong> file.</p>
  </li>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane of the Contoso.Events - Microsoft Visual Studio window, expand the <strong>Contoso.Events.Worker</strong> project.</p>
  </li>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane, double-click <strong>local.settings.json</strong>.</p>
  </li>
  <li>
    <p>In the JSON object, in line 4, locate the <strong>AzureWebJobsStorage</strong> path. Observe that the current value is empty:</p>

    <pre><code> "AzureWebJobsStorage": "",	
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>AzureWebJobsStorage</strong> property by setting it’s value to the <strong>Connection String</strong> of the <strong>Storage account</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>In the JSON object, in line 5, locate the <strong>AzureWebJobsDashboard</strong> path. Observe that the current value is empty:</p>

    <pre><code> "AzureWebJobsDashboard": "",
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>AzureWebJobsDashboard</strong> property by setting it’s value to the <strong>Connection String</strong> of the <strong>Storage account</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>In the JSON object, in line 6, locate the <strong>EventsContextConnectionString</strong> path. Observe that the current value is empty:</p>

    <pre><code> "EventsContextConnectionString": "",
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>EventsContextConnectionString</strong> property by setting it’s value to the <strong>Connection String</strong> of the <strong>SQL Database</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>In the JSON object, in line 7, locate the <strong>CosmosEndpointUrl</strong> path. Observe that the current value is empty:</p>

    <pre><code> "CosmosEndpointUrl": "",
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>CosmosEndpointUrl</strong> property by setting it’s value to the <strong>Endpoint Uri</strong> of the <strong>Azure Cosmos DB account</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>In the JSON object, in line 8, locate the <strong>CosmosAuthorizationKey</strong> path. Observe that the current value is empty:</p>

    <pre><code> "CosmosAuthorizationKey": "",
</code></pre>
  </li>
  <li>
    <p>Update the value of the <strong>CosmosAuthorizationKey</strong> property by setting it’s value to the <strong>Key</strong> of the <strong>Azure Cosmos DB account</strong> you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>Save the <strong>local.settings.json</strong> file.</p>
  </li>
</ol>

<h2 id="exercise-2-populating-the-container-with-files-and-media">Exercise 2: Populating the Container with Files and Media</h2>

<h4 id="task-1-implement-blob-trigger-and-output-for-azure-functions">Task 1: Implement Blob Trigger and Output For Azure Functions</h4>

<ol>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane of the Contoso.Events - Microsoft Visual Studio window, expand the <strong>Contoso.Events.Worker</strong> project and double-click the <strong>ProcessDocuments.cs</strong> file.</p>
  </li>
  <li>
    <p>In the code editor tab for the <strong>ProcessDocuments.cs</strong> file, locate the <strong>ProcessDocuments</strong> class:</p>

    <pre><code> public static class ProcessDocuments
</code></pre>
  </li>
  <li>
    <p>Within the <strong>ProcessDocuments</strong> class, locate the <strong>Run</strong> method:</p>

    <pre><code> public static async Task Run(Stream input, string name, Stream output, TraceWriter log)
</code></pre>
  </li>
  <li>
    <p>Update the method signature of the <strong>Run</strong> method by adding a <strong>BlobTrigger</strong> parameter attribute to the <strong>input</strong> parameter specifying to match on any blob in the <strong>signinsheets-pending</strong> container:</p>

    <pre><code> public static async Task Run([BlobTrigger("signinsheets-pending/{name}")] Stream input, string name, Stream output, TraceWriter log)
</code></pre>
  </li>
  <li>
    <p>Update the method signature of the <strong>Run</strong> method by adding a <strong>Blob</strong> parameter attribute to the <strong>output</strong> parameter specifying to create a new blob in the <strong>signinsheets</strong> container with the same name as the blob that triggered the function execution:</p>

    <pre><code> public static async Task Run([BlobTrigger("signinsheets-pending/{name}")] Stream input, string name, [Blob("signinsheets/{name}", FileAccess.Write)] Stream output, TraceWriter log)
</code></pre>
  </li>
  <li>
    <p>Within the <strong>Run</strong> method, add a new line of code at line 23 to get the <strong>Event Key</strong> by stripping the file extension from the name of the blob:</p>

    <pre><code> string eventKey = Path.GetFileNameWithoutExtension(name);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code at line 24 to create a using block using the <strong>Stream</strong> result from an invocation of the <strong>ProcessStorageMessage</strong> method:</p>

    <pre><code> using (MemoryStream stream = await ProcessStorageMessage(eventKey))
 {

 }
</code></pre>
  </li>
  <li>
    <p>Within the <em>using</em> block, add a new line of code to create a new variable of type <strong>byte[]</strong> by invoking the <strong>ToArray</strong> method of the stream:</p>

    <pre><code> byte[] byteArray = stream.ToArray();
</code></pre>
  </li>
  <li>
    <p>Still within the <em>using</em> block, add another line of code to invoke the <strong>WriteAsync</strong> method of the <strong>output</strong> variable passing in various metadata related to the <strong>byteArray</strong> variable:</p>

    <pre><code> await output.WriteAsync(byteArray, 0, byteArray.Length);
</code></pre>
  </li>
  <li>
    <p>Save the <strong>ProcessDocuments.cs</strong> file.</p>
  </li>
</ol>

<h4 id="task-2-implement-blob-upload-in-blobcontext-class">Task 2: Implement Blob Upload in BlobContext Class</h4>

<ol>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane of the Contoso.Events - Microsoft Visual Studio window, expand the <strong>Contoso.Events.Data</strong> project and double-click the <strong>BlobContext.cs</strong> file.</p>
  </li>
  <li>
    <p>In the code editor tab for the <strong>BlobContext.cs</strong> file, locate the <strong>BlobContext</strong> class:</p>

    <pre><code> public class BlobContext
</code></pre>
  </li>
  <li>
    <p>Within the <strong>BlobContext</strong> class, locate the <strong>UploadBlobAsync</strong> method and delete any existing code within the method:</p>

    <pre><code> public async Task&lt;ICloudBlob&gt; UploadBlobAsync(string blobName, Stream stream)
 {
        
 }
</code></pre>
  </li>
  <li>
    <p>Within the <strong>UploadBlobAsync</strong> method, add a new line of code to create a new <strong>CloudStorageAccount</strong> class instance:</p>

    <pre><code> CloudStorageAccount account = CloudStorageAccount.Parse(StorageSettings.ConnectionString);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to create a new instance of the <strong>CloudBlobClient</strong> class using the <strong>CreateCloudBlobClient</strong> method of the <strong>CloudStorageAccount</strong> class:</p>

    <pre><code> CloudBlobClient blobClient = account.CreateCloudBlobClient();
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to get a reference to a new or existing container using the <strong>GetContainerReference</strong> method of the <strong>CloudBlobClient</strong> class:</p>

    <pre><code> CloudBlobContainer container = blobClient.GetContainerReference($"{StorageSettings.ContainerName}-pending");
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to invoke the <strong>CreateIfNotExistsAsync</strong> method of the <strong>CloudBlobContainer</strong> class that will create the container if it does not already exist:</p>

    <pre><code> await container.CreateIfNotExistsAsync();
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to get a reference to a new of existing blob using the specified blob name:</p>

    <pre><code> ICloudBlob blob = container.GetBlockBlobReference(blobName);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to take your <strong>stream</strong> parameter and “rewind” the stream back to it’s origin:</p>

    <pre><code> stream.Seek(0, SeekOrigin.Begin);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to upload the <strong>stream</strong> parameter’s content to the referenced blob:</p>

    <pre><code> await blob.UploadFromStreamAsync(stream);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to return the updated blob as the result of the method:</p>

    <pre><code> return blob;
</code></pre>
  </li>
</ol>

<h4 id="task-3-validate-sign-in-sheet-generation">Task 3: Validate Sign-In Sheet Generation</h4>

<ol>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane, right-click the <strong>Contoso.Events</strong> solution, and then click <strong>Properties</strong>.</p>
  </li>
  <li>
    <p>Navigate to the <strong>Startup Project</strong> section located under the <strong>Common Properties</strong> header.</p>
  </li>
  <li>
    <p>In the <strong>Startup Project</strong> section, locate and select the <strong>Multiple startup projects</strong> option.</p>
  </li>
  <li>
    <p>Within the <strong>Multiple startup projects</strong> table, perform the following actions:</p>

    <p>b. Locate the <strong>Contoso.Events.Management</strong> entry and change it’s <em>Action</em> from <strong>None</strong> to <strong>Start</strong>.</p>

    <p>c. Locate the <strong>Contoso.Events.Worker</strong> entry and change it’s <em>Action</em> from <strong>None</strong> to <strong>Start</strong>.</p>
  </li>
  <li>
    <p>Click the <strong>OK</strong> button to close the <em>Property</em> dialog.</p>
  </li>
  <li>
    <p>On the <strong>Debug</strong> menu, click <strong>Start Debugging</strong>.</p>
  </li>
  <li>
    <p>On the home page of the web application, verify that it displays a list of events.</p>
  </li>
  <li>
    <p>Click the <strong>Generate Sign-In Sheet</strong> button for any of the events in the list. Remember the name of the event as you will click the same button again in this lab.</p>
  </li>
  <li>
    <p>You will observe that the Azure Function will immediately detect the new document in the <strong>signinsheets-pending</strong> container and begin processing that document. Once it is done processing, it will create a new copy of the document in the <strong>signinsheets</strong> container.</p>

    <blockquote>
      <p><strong>Note</strong>: This can take up to a minute to occur.</p>
    </blockquote>
  </li>
  <li>
    <p>Refresh the browser window that is displaying the website.</p>
  </li>
  <li>
    <p>You should now see a section titled <strong>Sign-In Document Already Exists</strong>. This indicates that the sign-in document was generated successfully.</p>
  </li>
  <li>
    <p>Open the downloaded <em>docx</em> file on your local machine. Observe and then close the file.</p>
  </li>
  <li>
    <p>Close the browser window that is displaying the website.</p>
  </li>
  <li>
    <p>Close the console window for the Azure Functions instance.</p>
  </li>
</ol>

<h4 id="task-4-sign-in-to-the-azure-portal">Task 4: Sign in to the Azure Portal</h4>

<ol>
  <li>
    <p>On the Start screen, click the <strong>Internet Explorer</strong> tile.</p>
  </li>
  <li>
    <p>Go to <em>(<a href="https://portal.azure.com">https://portal.azure.com</a>)</em>.</p>
  </li>
  <li>
    <p>In the email address box, type the email address of your Microsoft account.</p>
  </li>
  <li>
    <p>Click <strong>Next</strong>.</p>
  </li>
  <li>
    <p>In the password box, type the password for your Microsoft account.</p>
  </li>
  <li>
    <p>Click <strong>Sign In</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: If this is your first time logging in to the Portal, you may be prompted with a “Welcome” dialog. You can safely close this dialog and continue.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-5-validate-azure-storage-data">Task 5: Validate Azure Storage Data</h4>

<ol>
  <li>
    <p>In the <strong>All services</strong> blade that displays, click <strong>Storage accounts</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Storage accounts</strong> blade that displays, select the Azure Cosmos DB account instance that has a prefix of <strong>star20532</strong>.</p>
  </li>
  <li>
    <p>In the <em>Storage account</em> blade, click the <strong>Blobs</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Blob service</strong> blade, click the <strong>signinsheets</strong> link to view the container.</p>
  </li>
  <li>
    <p>In the <strong>Blob container</strong> blade, observe the documents in the container.</p>
  </li>
</ol>

<h2 id="exercise-3-retrieving-files-and-media-from-the-container">Exercise 3: Retrieving Files and Media from the Container</h2>

<h4 id="task-1-implement-blob-access-using-direct-download">Task 1: Implement Blob Access using Direct Download</h4>

<ol>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane of the Contoso.Events - Microsoft Visual Studio window, expand the <strong>Contoso.Events.Data</strong> project and double-click the <strong>BlobContext.cs</strong> file.</p>
  </li>
  <li>
    <p>In the code editor tab for the <strong>BlobContext.cs</strong> file, locate the <strong>BlobContext</strong> class:</p>

    <pre><code> public class BlobContext
</code></pre>
  </li>
  <li>
    <p>Within the <strong>BlobContext</strong> class, locate the <strong>GetStreamAsync</strong> method and delete any existing code within the method:</p>

    <pre><code> public async Task&lt;DownloadPayload&gt; GetStreamAsync(string blobId)
 {
		
 }
</code></pre>
  </li>
  <li>
    <p>Within the <strong>GetStreamAsync</strong> method, add a new line of code to create a new <strong>CloudStorageAccount</strong> class instance:</p>

    <pre><code> CloudStorageAccount account = CloudStorageAccount.Parse(StorageSettings.ConnectionString);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to create a new instance of the <strong>CloudBlobClient</strong> class using the <strong>CreateCloudBlobClient</strong> method of the <strong>CloudStorageAccount</strong> class:</p>

    <pre><code> CloudBlobClient blobClient = account.CreateCloudBlobClient();
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to get a reference to a new or existing container using the <strong>GetContainerReference</strong> method of the <strong>CloudBlobClient</strong> class:</p>

    <pre><code> CloudBlobContainer container = blobClient.GetContainerReference(StorageSettings.ContainerName);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to invoke the <strong>CreateIfNotExistsAsync</strong> method of the <strong>CloudBlobContainer</strong> class that will create the container if it does not already exist:</p>

    <pre><code> await container.CreateIfNotExistsAsync();
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to get a reference to a new of existing blob using the specified blob name:</p>

    <pre><code> ICloudBlob blob = container.GetBlockBlobReference(blobId);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to take create a new <strong>Stream</strong> class instance with the data from your referenced blob:</p>

    <pre><code> Stream blobStream = await blob.OpenReadAsync(null, null, null);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to return the <strong>blobStream</strong> variable with the streamed data from your blob as the result of the method:</p>

    <pre><code> return new DownloadPayload { Stream = blobStream, ContentType = blob.Properties.ContentType };
</code></pre>
  </li>
</ol>

<h4 id="task-2-validate-sign-in-sheet-download">Task 2: Validate Sign-In Sheet Download</h4>

<ol>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane, right-click the <strong>Contoso.Events.Management</strong> project, and then click <strong>Set as Startup Project</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Debug</strong> menu, click <strong>Start Debugging</strong>.</p>
  </li>
  <li>
    <p>On the home page of the web application, verify that it displays a list of events.</p>
  </li>
  <li>
    <p>Click the <strong>Generate Sign-In Sheet</strong> button for the same event you used earlier in this lab.</p>
  </li>
  <li>
    <p>On the sign-in sheet page, you should see a section titled <strong>Sign-In Document Already Exists</strong>.</p>
  </li>
  <li>
    <p>Click the <strong>Download Sign-In Sheet Stream</strong> link to download the document as a stream from the web server.</p>
  </li>
  <li>
    <p>Close the browser window that is displaying the website.</p>
  </li>
</ol>

<h2 id="exercise-4-specifying-permissions-for-the-container">Exercise 4: Specifying Permissions for the Container</h2>

<h4 id="task-1-securing-blob-container">Task 1: Securing Blob Container</h4>

<ol>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane of the Contoso.Events - Microsoft Visual Studio window, expand the <strong>Contoso.Events.Data</strong> project and double-click the <strong>BlobContext.cs</strong> file.</p>
  </li>
  <li>
    <p>In the code editor tab for the <strong>BlobContext.cs</strong> file, locate the <strong>BlobContext</strong> class:</p>

    <pre><code> public class BlobContext
</code></pre>
  </li>
  <li>
    <p>Within the <strong>BlobContext</strong> class, locate the <strong>GetSecureUrlAsync</strong> method and delete any existing code within the method:</p>

    <pre><code> public async Task&lt;string&gt; GetSecureUrlAsync(string blobId)
 {
		
 }
</code></pre>
  </li>
  <li>
    <p>Within the <strong>GetSecureUrlAsync</strong> method, add a new line of code to create a new <strong>CloudStorageAccount</strong> class instance:</p>

    <pre><code> CloudStorageAccount account = CloudStorageAccount.Parse(StorageSettings.ConnectionString);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to create a new instance of the <strong>CloudBlobClient</strong> class using the <strong>CreateCloudBlobClient</strong> method of the <strong>CloudStorageAccount</strong> class:</p>

    <pre><code> CloudBlobClient blobClient = account.CreateCloudBlobClient();
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to get a reference to a new or existing container using the <strong>GetContainerReference</strong> method of the <strong>CloudBlobClient</strong> class:</p>

    <pre><code> CloudBlobContainer container = blobClient.GetContainerReference(StorageSettings.ContainerName);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to invoke the <strong>CreateIfNotExistsAsync</strong> method of the <strong>CloudBlobContainer</strong> class that will create the container if it does not already exist:</p>

    <pre><code> await container.CreateIfNotExistsAsync();
</code></pre>
  </li>
  <li>
    <p>Add a new block of code to create a new instance of the <strong>SharedAccessBlobPolicy</strong> class setting various parameter of the policy:</p>

    <pre><code> SharedAccessBlobPolicy blobPolicy = new SharedAccessBlobPolicy
 {
     SharedAccessExpiryTime = DateTime.Now.AddHours(0.25d),
     Permissions = SharedAccessBlobPermissions.Read
 };
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to create a new instance of the <strong>BlobContainerPermissions</strong> class setting various parameters:</p>

    <pre><code> BlobContainerPermissions blobPermissions = new BlobContainerPermissions
 {
     PublicAccess = BlobContainerPublicAccessType.Off
 };
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to add the <strong>blobPolicy</strong> variable with a key of <strong>ReadBlobPolicy</strong> to the <strong>SharedAccessPolicies</strong> collection of the <strong>blobPermissions</strong> variable:</p>

    <pre><code> blobPermissions.SharedAccessPolicies.Add("ReadBlobPolicy", blobPolicy);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to update the container by invoking the <strong>SetPermissionsAsync</strong> method of the <strong>container</strong> variable:</p>

    <pre><code> await container.SetPermissionsAsync(blobPermissions);
</code></pre>
  </li>
</ol>

<h4 id="task-2-implement-blob-access-using-secure-url">Task 2: Implement Blob Access using Secure URL</h4>

<ol>
  <li>
    <p>Add a new line of code to generate a new SAS Token using the <strong>ReadBlobPolicy</strong> key and store the string result in the <strong>sasToken</strong> variable:</p>

    <pre><code> string sasToken = container.GetSharedAccessSignature(new SharedAccessBlobPolicy(), "ReadBlobPolicy");
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to get a reference to a new of existing blob using the specified blob name:</p>

    <pre><code> ICloudBlob blob = container.GetBlockBlobReference(blobId);
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to get the <strong>Uri</strong> of the <strong>blob</strong> variable:</p>

    <pre><code> Uri blobUrl = blob.Uri;
</code></pre>
  </li>
  <li>
    <p>Add a new line of code to return the concatenation of the <strong>sasToken</strong> variable and the <strong>AbsoluteUri</strong> property of the <strong>blobUrl</strong> variable:</p>

    <pre><code> return blobUrl.AbsoluteUri + sasToken;
</code></pre>
  </li>
</ol>

<h4 id="task-3-validate-sign-in-sheet-hyperlink">Task 3: Validate Sign-In Sheet Hyperlink</h4>

<ol>
  <li>
    <p>In the <strong>Solution Explorer</strong> pane, right-click the <strong>Contoso.Events.Management</strong> project, and then click <strong>Set as Startup Project</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Debug</strong> menu, click <strong>Start Debugging</strong>.</p>
  </li>
  <li>
    <p>On the home page of the web application, verify that it displays a list of events.</p>
  </li>
  <li>
    <p>Click the <strong>Generate Sign-In Sheet</strong> button for the same event you used earlier in this lab.</p>
  </li>
  <li>
    <p>On the sign-in sheet page, you should see a section titled <strong>Sign-In Document Already Exists</strong>.</p>
  </li>
  <li>
    <p>Click the <strong>Use Sign-In Sheet Hyperlink</strong> link to download the document as a stream from the web server.</p>
  </li>
  <li>
    <p>Close the browser window that is displaying the website.</p>
  </li>
</ol>

<h2 id="exercise-4-cleanup-subscription">Exercise 4: Cleanup Subscription</h2>

<h4 id="task-1-open-cloud-shell">Task 1: Open Cloud Shell</h4>

<ol>
  <li>
    <p>At the top of the portal, click the <strong>Cloud Shell</strong> icon to open a new shell instance.</p>
  </li>
  <li>
    <p>In the <strong>Cloud Shell</strong> command prompt at the bottom of the portal, type in the following command and press <strong>Enter</strong> to list all resource groups in the subscription:</p>

    <pre><code> az group list
</code></pre>
  </li>
  <li>
    <p>Type in the following command and press <strong>Enter</strong> to view a list of possible CLI commands to <em>delete a Resource Group</em>:</p>

    <pre><code> az group delete --help
</code></pre>
  </li>
</ol>

<h4 id="task-2-delete-resource-group">Task 2: Delete Resource Group</h4>

<ol>
  <li>
    <p>Type in the following command and press <strong>Enter</strong> to delete the <strong>MOD07STOR</strong> <em>Resource Group</em>:</p>

    <pre><code> az group delete --name MOD07STOR --no-wait --yes
</code></pre>
  </li>
  <li>
    <p>Close the <strong>Cloud Shell</strong> prompt at the bottom of the portal.</p>
  </li>
</ol>

<h4 id="task-3-close-active-applications">Task 3: Close Active Applications</h4>

<ol>
  <li>
    <p>Close the currently running web browser application.</p>
  </li>
  <li>
    <p>Close the currently running <strong>Visual Studio</strong> application.</p>
  </li>
</ol>

<blockquote>
  <p><strong>Review</strong>: In this exercise, you “cleaned up your subscription” by removing the <strong>Resource Groups</strong> used in this lab.</p>
</blockquote>

            </article>
        </main>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>
        $(function() {
            $('article img').each(function() {
                var src = $(this).attr('src');
                $(this).wrap('<a href="/Instructions/Labs/Mod07/'&#32;+&#32;src&#32;+&#32;'" target="_blank"></a>');
            });
            $('article > h2').each(function() {
                $('nav.toc > ul').append(
                    $('<li>')
                        .attr('class', 'nav-item')
                        .append(
                            $('<a>')
                                .attr('class', 'nav-link')
                                .text($(this).text())
                                .attr('href', '#' + $(this).attr('id'))
                        ) 
                );
            });
            $('[data-spy="scroll"]').each(function () {
                var $spy = $(this).scrollspy('refresh')
            });
        });
    </script>
</body>

</html>
